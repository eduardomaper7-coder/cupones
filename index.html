import React, { useEffect, useState, useRef } from "react";

// Single-file React component designed for mobile (TailwindCSS assumed available in the project)
// - Default export: CardPrizeGame
// - Uses Tailwind classes, framer-motion optional but not required
// - Mobile-first, animated, casino/giftbox-style experience

export default function CardPrizeGame() {
  const [phase, setPhase] = useState("intro"); // intro -> shuffling -> choose -> reveal -> celebrate -> final
  const [shuffling, setShuffling] = useState(false);
  const [chosen, setChosen] = useState(null);
  const [revealedIndex, setRevealedIndex] = useState(null);
  const [prizeText, setPrizeText] = useState("");

  // Tickets / Coins state
  const [euros, setEuros] = useState(0);
  const [discount, setDiscount] = useState(0);
  const [coins, setCoins] = useState(0);

  const [progress, setProgress] = useState(20); // progress bar percent (example start)

  const cardsRef = useRef(null);

  // card data (hidden prizes) - you can change this array to fetch from backend
  const cardPrizes = [
    { id: 0, title: "Pase gratuito fitness", description: "Pase gratuito a un centro fitness" },
    { id: 1, title: "10% DTO. en tu próxima compra", description: "Descuento especial" },
    { id: 2, title: "2000 Coins", description: "Coins para canjear" },
  ];

  useEffect(() => {
    // start intro animation then go to shuffling
    const t = setTimeout(() => {
      startShuffling();
    }, 1600);
    return () => clearTimeout(t);
  }, []);

  function startShuffling() {
    setPhase("shuffling");
    setShuffling(true);
    // shuffle animation duration (2.2s). After that, allow user to choose
    setTimeout(() => {
      setShuffling(false);
      setPhase("choose");
    }, 2200);
  }

  function handleChoose(index) {
    if (phase !== "choose") return;
    setChosen(index);
    setPhase("reveal");

    // reveal animation
    setTimeout(() => {
      setRevealedIndex(index);
      // After reveal, show prize, confetti and increment tickets
      setTimeout(() => {
        showPrizeEffects(index);
      }, 600); // slight delay until card fully flipped
    }, 300);
  }

  function showPrizeEffects(index) {
    const prize = cardPrizes[index];
    setPrizeText(prize.description || prize.title);
    setPhase("celebrate");

    // Random increments as requested
    const addEuros = Math.floor(Math.random() * 6) + 5; // 5..10
    const addDiscount = Math.floor(Math.random() * 11) + 5; // 5..15
    const addCoins = Math.floor(Math.random() * 1001) + 1000; // 1000..2000

    // Step-up animation for euros
    animateValue(setEuros, euros, euros + addEuros, 900);

    // Delay the discount ticket slightly later (so it appears after euros)
    setTimeout(() => {
      animateValue(setDiscount, discount, discount + addDiscount, 900);
    }, 600);

    // Show coins below with slight delay
    setTimeout(() => {
      animateValue(setCoins, coins, coins + addCoins, 1000);
    }, 900);

    // progress increase
    setProgress((p) => Math.min(100, p + 20));
  }

  // smooth integer animation helper
  function animateValue(setter, from, to, duration) {
    const start = performance.now();
    function step(now) {
      const t = Math.min(1, (now - start) / duration);
      const val = Math.round(from + (to - from) * t);
      setter(val);
      if (t < 1) requestAnimationFrame(step);
    }
    requestAnimationFrame(step);
  }

  // Helper to render cards with animations
  function renderCard(i) {
    const isChosen = chosen === i;
    const isRevealed = revealedIndex === i;
    const otherRevealed = revealedIndex !== null && revealedIndex !== i;

    const classes = [
      "w-28 h-40 sm:w-36 sm:h-48 md:w-44 md:h-60",
      "rounded-xl shadow-2xl",
      "relative",
      "transform-gpu",
      "transition-all",
      "duration-600",
      "flex-shrink-0",
    ];

    // If shuffling, apply a small translate/rotate animation via class
    if (shuffling) {
      classes.push("animate-shuffle");
    }

    // If chosen and revealed, scale up
    if (isRevealed) {
      classes.push("z-40 scale-110");
    }

    // If another card revealed, make this grayscale / faded
    if (otherRevealed) {
      classes.push("filter grayscale opacity-30");
    }

    // If phase is choose, make cards tappable
    const clickable = phase === "choose" && !shuffling && !otherRevealed;

    return (
      <div
        key={i}
        className={classes.join(" ")}
        onClick={() => clickable && handleChoose(i)}
        role="button"
        style={{ perspective: 1000 }}
      >
        <div
          className={`relative w-full h-full transition-transform duration-500 transform-style-preserve-3d ${isRevealed ? "rotate-y-180" : ""}`}
        >
          {/* Front face (card back) */}
          <div className="absolute inset-0 backface-hidden bg-gradient-to-br from-purple-600 to-pink-500 rounded-xl flex items-center justify-center text-white text-center px-2">
            <div className="text-sm sm:text-base font-bold">Elige tu carta</div>
          </div>

          {/* Back face (revealed prize) */}
          <div className="absolute inset-0 backface-hidden rotate-y-180 bg-white rounded-xl shadow-inner flex flex-col items-center justify-center px-3">
            <div className="text-xs sm:text-sm text-gray-500">Premio</div>
            <div className="text-sm sm:text-lg font-extrabold text-center mt-2">{cardPrizes[i].title}</div>
            {isRevealed && (
              <div className="mt-3 text-xs sm:text-sm text-gray-600">{cardPrizes[i].description}</div>
            )}
          </div>
        </div>
      </div>
    );
  }

  // small confetti generator (DOM-based) - create pieces when celebrate
  function ConfettiPieces({ play }) {
    const [pieces, setPieces] = useState([]);

    useEffect(() => {
      if (!play) return;
      const count = 22;
      const newPieces = Array.from({ length: count }).map((_, i) => ({
        id: i,
        left: Math.random() * 80 + 10,
        delay: Math.random() * 0.6,
        rot: Math.random() * 360,
        size: Math.random() * 10 + 6,
      }));
      setPieces(newPieces);
      const clearT = setTimeout(() => setPieces([]), 2400);
      return () => clearTimeout(clearT);
    }, [play]);

    if (!play) return null;

    return (
      <div className="pointer-events-none absolute inset-0 z-50 overflow-hidden">
        {pieces.map((p) => (
          <div
            key={p.id}
            className="absolute rounded-sm"
            style={{
              left: `${p.left}%`,
              top: `-10%`,
              width: `${p.size}px`,
              height: `${p.size * 0.6}px`,
              background: `linear-gradient(90deg, rgba(255,220,0,1), rgba(255,60,120,1))`,
              transform: `rotate(${p.rot}deg)`,
              animation: `confettiFall 2s ${p.delay}s forwards ease-in`,
              borderRadius: '2px',
            }}
          />
        ))}
      </div>
    );
  }

  // Coins float animation
  function CoinsFloating({ play }) {
    if (!play) return null;
    const arr = Array.from({ length: 8 });
    return (
      <div className="absolute inset-0 z-40 pointer-events-none">
        {arr.map((_, i) => (
          <div
            key={i}
            className="absolute text-xs font-bold"
            style={{
              left: `${10 + i * 10}%`,
              top: `${50 - i * 3}%`,
              animation: `coinFloat 1.4s ${i * 0.07}s forwards ease-out`,
            }}
          >
            <div className="w-8 h-8 rounded-full bg-yellow-300 border-2 border-yellow-500 flex items-center justify-center shadow-md">¢</div>
          </div>
        ))}
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gradient-to-b from-gray-900 via-purple-900 to-pink-800 text-white flex flex-col items-center p-4 sm:p-6">
      {/* Top bar: Tickets and Coins */}
      <div className="w-full max-w-md relative">
        <div className="flex justify-between items-center mb-2">
          {/* Euros ticket (upper-left) */}
          <div className="flex items-center">
            <div className="ticket-white px-2 py-1 rounded-md shadow-lg flex items-center gap-2">
              <div className="text-xs">€</div>
              <div className="text-sm sm:text-base font-extrabold">{euros}</div>
            </div>
          </div>

          {/* Center coins circle */}
          <div className="flex items-center justify-center">
            <div className="relative">
              <div className="rounded-full bg-white/10 backdrop-blur-md border-2 border-white/20 w-16 h-16 flex items-center justify-center flex-col">
                <div className="text-xs">COINS</div>
                <div className="text-sm font-bold">{coins}</div>
              </div>
            </div>
          </div>

          {/* Discount ticket (upper-right) */}
          <div className="flex items-center">
            <div className="ticket-white px-2 py-1 rounded-md shadow-lg flex items-center gap-2">
              <div className="text-xs">%</div>
              <div className="text-sm sm:text-base font-extrabold">{discount}</div>
            </div>
          </div>
        </div>
      </div>

      {/* Main area: animated phrase + cards */}
      <div className="flex-1 w-full max-w-md flex flex-col items-center justify-center relative">
        {/* Animated phrase */}
        <div className="mb-4 text-center">
          <div className={`text-2xl sm:text-3xl font-extrabold animate-pulse-spark`}>Elige bien, tu premio te espera detrás de una carta</div>
        </div>

        {/* Cards row */}
        <div className="w-full flex items-center justify-center my-2 overflow-hidden">
          <div ref={cardsRef} className="flex items-center justify-center gap-4 touch-pan-y">
            {renderCard(0)}
            {renderCard(1)}
            {renderCard(2)}
          </div>
        </div>

        {/* Reveal / Celebration overlays */}
        {phase === "reveal" || phase === "celebrate" ? (
          <>
            <ConfettiPieces play={phase === "celebrate"} />
            <CoinsFloating play={phase === "celebrate"} />
          </>
        ) : null}

        {/* After reveal show big text in center */}
        {phase === "celebrate" && (
          <div className="absolute inset-0 flex items-center justify-center z-50 pointer-events-none">
            <div className="bg-white/5 backdrop-blur-md p-4 rounded-2xl text-center max-w-xs shadow-2xl">
              <div className="text-lg sm:text-2xl font-bold mb-2">¡Felicidades!</div>
              <div className="text-sm sm:text-base">Has ganado: <span className="font-extrabold">{prizeText}</span></div>
            </div>
          </div>
        )}
      </div>

      {/* Bottom progress bar */}
      <div className="w-full max-w-md py-3">
        <div className="text-xs text-center mb-2">Progreso: {progress}%</div>
        <div className="w-full bg-white/10 rounded-full h-4 overflow-hidden">
          <div className="h-full rounded-full transition-all duration-700" style={{ width: `${progress}%`, background: 'linear-gradient(90deg, #FFD700, #FF6EC7)' }} />
        </div>
      </div>

      {/* Small action area - reset or play again */}
      <div className="w-full max-w-md flex justify-center gap-3">
        <button
          className="px-4 py-2 rounded-full bg-white/10 backdrop-blur-md hover:bg-white/20 transition"
          onClick={() => {
            // reset to initial state for testing
            setPhase("intro");
            setShuffling(false);
            setChosen(null);
            setRevealedIndex(null);
            setPrizeText("");
            setEuros(0);
            setDiscount(0);
            setCoins(0);
            setProgress(20);
            setTimeout(() => startShuffling(), 250);
          }}
        >
          Volver a jugar
        </button>
      </div>

      {/* Styles: keyframes and utility classes that Tailwind may not provide out of the box */}
      <style>{`
        /* 3D flip helpers */
        .backface-hidden { backface-visibility: hidden; -webkit-backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }

        /* shuffle animation */
        @keyframes shuffleA { 0%{ transform: translateY(0) rotate(0deg);} 25%{ transform: translateY(-6px) rotate(-6deg);} 50%{ transform: translateY(6px) rotate(6deg);} 75%{ transform: translateY(-4px) rotate(-2deg);} 100%{ transform: translateY(0) rotate(0deg);} }
        .animate-shuffle { animation: shuffleA 0.35s infinite; }

        /* confetti falling */
        @keyframes confettiFall { to { transform: translateY(120vh) rotate(360deg); opacity: 1; } }

        /* coin float */
        @keyframes coinFloat { from { transform: translateY(0) scale(1); opacity: 1; } to { transform: translateY(-140px) scale(1.05); opacity: 0; } }

        /* pulse spark for headline */
        @keyframes pulseSpark { 0% { text-shadow: 0 0 6px rgba(255,255,255,0.0);} 50% { text-shadow: 0 0 18px rgba(255,255,255,0.9);} 100% { text-shadow: 0 0 6px rgba(255,255,255,0.0);} }
        .animate-pulse-spark { animation: pulseSpark 1.8s infinite; }

        /* ticket look (white with gold-ish touches) */
        .ticket-white {
          background: linear-gradient(180deg,#ffffff,#f8f6f2);
          color: #111827;
          border: 1px solid rgba(217, 180, 75, 0.55);
          box-shadow: 0 6px 18px rgba(249,213,86,0.12), inset 0 -2px 0 rgba(217, 180, 75, 0.08);
        }

        /* small responsive tweaks */
        @media(min-width: 640px){ .w-28 { width: 7rem; } }

      `}</style>
    </div>
  );
}
