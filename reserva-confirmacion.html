<script>
(function(){
  const actividades = [
    {nombre:"Clase de Yoga", precio:15},
    {nombre:"Acceso gimnasio", precio:5.50},
    {nombre:"Clase de Pilates", precio:15},
    {nombre:"Clase de Zumba", precio:15},
    {nombre:"Entrenamiento funcional", precio:15},
    {nombre:"Clase de Danza", precio:15},
  ];

  const totalGanado = 7; // siempre 7€
  const lista=document.getElementById("actividades");

  actividades.forEach(act=>{
    const div=document.createElement("div");
    div.className="actividad";
    div.innerHTML=`<div>${act.nombre} — 
        <span class="precio ${act.precio==5.5?"verde":"rojo"}">${act.precio}€</span>
      </div>`;
    div.addEventListener("click",()=>{
      div.querySelectorAll("button").forEach(b=>b.remove());
      const btn=document.createElement("button");
      if(totalGanado>=act.precio){
        btn.textContent="Reservar";
        btn.className="boton reservar";
      }else{
        btn.textContent="Reservar y pagar diferencia en caja";
        btn.className="boton reservar-caja";
      }
      btn.onclick=()=>goToConfirm(act);
      div.appendChild(btn);
    });
    lista.appendChild(div);
  });

  // animación monedero
  let start=Date.now(), dur=5000;
  function anim(){
    let p=Math.min(1,(Date.now()-start)/dur);
    let val=(totalGanado*p).toFixed(2);
    document.getElementById("monedero").textContent=val+"€";
    if(p<1)requestAnimationFrame(anim);
  }
  anim();

  function goToConfirm(act){
    document.getElementById("screen-reserva").classList.add("hidden");
    document.getElementById("screen-confirmacion").classList.remove("hidden");

    const precio=act.precio;
    const ganado=totalGanado;
    const ahorro=Math.min(ganado,precio).toFixed(2);
    const pagar=(precio-ganado>0?(precio-ganado):0).toFixed(2);

    document.getElementById("resumen").innerHTML=`
      <div class="opcion">Opción: ${act.nombre}</div>
      <div class="ahorro">Ahorras: ${ahorro}€</div>
      <div class="pagar">A pagar: ${pagar}€</div>
    `;

    // contador
    let segundos=300;
    function tick(){
      let m=Math.floor(segundos/60), s=segundos%60;
      document.getElementById("contador").textContent=`${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
      if(segundos>0){segundos--;setTimeout(tick,1000);}
    }
    tick();

    // fecha límite
    const fecha=document.getElementById("fecha");
    const hoy=new Date();
    const max=new Date();
    max.setDate(hoy.getDate()+7);
    fecha.min=hoy.toISOString().split("T")[0];
    fecha.max=max.toISOString().split("T")[0];

    // envío al SheetDB
    document.getElementById("form").onsubmit=async function(e){
      e.preventDefault();

      const f=new Date(fecha.value+"T"+document.getElementById("hora").value);
      const dia=f.getDay();
      const hora=f.getHours(), min=f.getMinutes();
      let valido=false;

      if(dia>=1 && dia<=5){
        if(hora>=10 && (hora<20 || (hora===20 && min<=30))) valido=true;
      }else if(dia===6){
        if(hora>=10 && (hora<13 || (hora===13 && min<=30))) valido=true;
      }else{
        alert("Domingo cerrado");return;
      }
      if(!valido){alert("Hora no disponible");return;}

      const data = {
        fecha: fecha.value,
        hora: document.getElementById("hora").value,
        actividad: act.nombre,
        nombre: this.nombre.value,
        apellidos: this.apellidos.value,
        telefono: this.telefono.value
      };

      try {
        const res = await fetch("https://sheetdb.io/api/v1/55rfkpm3ogg4g", {
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body: JSON.stringify({ data })
        });
        const out = await res.json();
        alert("✅ Reserva confirmada y guardada");
      } catch(err){
        alert("❌ Error al enviar: "+err);
      }
    };
  }
})();
</script>

